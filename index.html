<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jdSite Demo</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <button id="menu-toggle" aria-label="Toggle Menu">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <header id="header"></header>
    <nav id="nav"></nav>
    <main id="content"></main>
    <footer id="footer"></footer>

    <script>
        
    // Configuration
    // =============================================================
    const CONFIG = {
        BASE_URL: '/jdsite/',
        PATHS: {
            components: 'components',
            content: 'content'
        },
        DEFAULT_PAGE: 'Home'  // Change this to whatever page you want as default
    };

    // Console checks
    console.log('Base URL:', CONFIG.BASE_URL);
    console.log('Components path:', CONFIG.PATHS.components);
    console.log('Content path:', CONFIG.PATHS.content);

    
    // Scripts
    // =============================================================

    // Configure marked to handle wikilinks
    marked.use({
        extensions: [{
            name: 'wikilink',
            level: 'inline',
            start(src) {
                const match = src.match(/\[\[/);
                return match?.index;
            },
            tokenizer(src) {
                const rule = /^\[\[([^\]\|]+)(?:\|([^\]]+))?\]\]/;
                const match = rule.exec(src);
                if (match) {
                    return {
                        type: 'wikilink',
                        raw: match[0],
                        text: match[2] || match[1],
                        link: match[1].trim(), // Remove trim() if you want to preserve leading/trailing spaces
                    };
                }
            },
            renderer(token) {
                return `<a href="#${token.link}">${token.text}</a>`;
            }
        }]
    });

// Utility functions
async function fetchMD(filename, type = 'content') {
    try {
        const path = type === 'components' ? CONFIG.PATHS.components : CONFIG.PATHS.content;
        filename = filename.replace(/^#/, '');
        const url = `${CONFIG.BASE_URL}${path}/${filename}.md`;
        console.log(`Attempting to fetch: ${url}`);

        const response = await fetch(url);

        // Check response status and provide detailed error
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: Failed to load ${url}`);
        }

        const text = await response.text();
        if (!text.trim()) {
            throw new Error(`Empty content received from ${url}`);
        }

        return text;
    } catch (error) {
        console.error(`Failed to fetch ${filename}.md:`, error);
        return `<div class="error-message">Failed to load ${filename}: ${error.message}</div>`;
    }
}

async function renderSection(id, filename) {
    const element = document.getElementById(id);
    if (!element) {
        console.error(`Element with id "${id}" not found`);
        return;
    }

    try {
        setLoading(id);
        const content = await fetchMD(filename, 'components');
        element.innerHTML = marked.parse(content);
    } catch (error) {
        console.error(`Error rendering ${id}:`, error);
        element.innerHTML = `<div class="error-message">Error loading ${id}</div>`;
    } finally {
        clearLoading(id);
    }
}

// Initialize with better error handling
async function init() {
    try {
        console.log('Starting initialization...');

        const components = [
            { id: 'header', file: 'header' },
            { id: 'nav', file: 'navmenu' },
            { id: 'footer', file: 'footer' }
        ];

        // Load components sequentially to better identify issues
        for (const comp of components) {
            console.log(`Loading ${comp.id}...`);
            await renderSection(comp.id, comp.file);
        }

        await loadPage();
        console.log('Initialization complete');
    } catch (error) {
        console.error('Critical initialization error:', error);
        document.body.innerHTML += `
            <div class="critical-error">
                <h2>Loading Error</h2>
                <p>Failed to initialize site components: ${error.message}</p>
            </div>`;
    }
}

    // Navigation handling
    function getCurrentPage() {
        const hash = window.location.hash.slice(1);
        return hash || CONFIG.DEFAULT_PAGE;
    }

    async function loadPage() {
        const page = getCurrentPage();
        setLoading('content');
        const content = await fetchMD(page, 'content');
        document.getElementById('content').innerHTML = marked.parse(content);
        clearLoading('content');
    }

    // Menu toggle
    document.getElementById('menu-toggle').addEventListener('click', () => {
        document.body.classList.toggle('menu-open');
    });

    // Close menu when clicking a link (mobile)
    document.addEventListener('click', (e) => {
        if (e.target.tagName === 'A') {
            document.body.classList.remove('menu-open');
        }
    });

    // Initialize
    async function init() {
        try {
            await Promise.all([
                renderSection('header', 'header'),
                renderSection('nav', 'navmenu'),
                renderSection('footer', 'footer')
            ]);
            await loadPage();
        } catch (error) {
            console.error('Initialization error:', error);
        }
    }

    window.addEventListener('hashchange', loadPage);
    window.addEventListener('load', init);

</script>
</body>
</html>
